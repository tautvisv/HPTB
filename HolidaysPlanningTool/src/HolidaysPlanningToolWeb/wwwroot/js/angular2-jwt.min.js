"use strict";function tokenNotExpired(e,t){var r,o=e||"id_token";r=t?t:localStorage.getItem(o);var n=new JwtHelper;return!r||n.isTokenExpired(r,null)?!1:!0}var __decorate=this&&this.__decorate||function(e,t,r,o){var n,i=arguments.length,a=3>i?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,r,o);else for(var s=e.length-1;s>=0;s--)(n=e[s])&&(a=(3>i?n(a):i>3?n(t,r,a):n(t,r))||a);return i>3&&a&&Object.defineProperty(t,r,a),a},__metadata=this&&this.__metadata||function(e,t){return"object"==typeof Reflect&&"function"==typeof Reflect.metadata?Reflect.metadata(e,t):void 0},core_1=require("angular2/core"),http_1=require("angular2/http"),Observable_1=require("rxjs/Observable"),AuthConfig=function(){function e(e){var t=this;this.config=e||{},this.headerName=this.config.headerName||"Authorization",this.headerPrefix=this.config.headerPrefix?this.config.headerPrefix+" ":this.config.noTokenScheme?"":"Bearer ",this.tokenName=this.config.tokenName||"id_token",this.noJwtError=this.config.noJwtError||!1,this.tokenGetter=this.config.tokenGetter||function(){return localStorage.getItem(t.tokenName)},this.globalHeaders=this.config.globalHeaders||null}return e.prototype.getConfig=function(){return{headerName:this.headerName,headerPrefix:this.headerPrefix,tokenName:this.tokenName,tokenGetter:this.tokenGetter,noJwtError:this.noJwtError,emptyHeaderPrefix:this.noTokenScheme,globalHeaders:this.globalHeaders}},e}();exports.AuthConfig=AuthConfig;var AuthHttp=function(){function e(e,t){var r=this;this.http=t,this._config=e.getConfig(),this.tokenStream=new Observable_1.Observable(function(e){e.next(r._config.tokenGetter())})}return e.prototype.setGlobalHeaders=function(e,t){e.forEach(function(e){var r=Object.keys(e)[0],o=e[r];t.headers.set(r,o)})},e.prototype.request=function(e,t){var r,o=this._config.globalHeaders;if(tokenNotExpired(null,this._config.tokenGetter()))if("string"==typeof e){var n=t||{};n.headers||(n.headers=new http_1.Headers),o&&this.setGlobalHeaders(o,n),n.headers.set(this._config.headerName,this._config.headerPrefix+this._config.tokenGetter()),r=this.http.request(e,n)}else{var i=e;i.headers||(i.headers=new http_1.Headers),o&&this.setGlobalHeaders(o,i),i.headers.set(this._config.headerName,this._config.headerPrefix+this._config.tokenGetter()),r=this.http.request(i)}else{if(!this._config.noJwtError)return new Observable_1.Observable(function(e){e.error(new Error("No JWT present"))});r=this.http.request(e,t)}return r},e.prototype.requestHelper=function(e,t){var r=new http_1.RequestOptions(e);return t&&(r=r.merge(t)),this.request(new http_1.Request(r))},e.prototype.get=function(e,t){return this.requestHelper({url:e,method:http_1.RequestMethod.Get},t)},e.prototype.post=function(e,t,r){return this.requestHelper({url:e,body:t,method:http_1.RequestMethod.Post},r)},e.prototype.put=function(e,t,r){return this.requestHelper({url:e,body:t,method:http_1.RequestMethod.Put},r)},e.prototype["delete"]=function(e,t){return this.requestHelper({url:e,method:http_1.RequestMethod.Delete},t)},e.prototype.patch=function(e,t,r){return this.requestHelper({url:e,body:t,method:http_1.RequestMethod.Patch},r)},e.prototype.head=function(e,t){return this.requestHelper({url:e,method:http_1.RequestMethod.Head},t)},e=__decorate([core_1.Injectable(),__metadata("design:paramtypes",[AuthConfig,http_1.Http])],e)}();exports.AuthHttp=AuthHttp;var JwtHelper=function(){function e(){}return e.prototype.urlBase64Decode=function(e){var t=e.replace(/-/g,"+").replace(/_/g,"/");switch(t.length%4){case 0:break;case 2:t+="==";break;case 3:t+="=";break;default:throw"Illegal base64url string!"}return decodeURIComponent(escape(window.atob(t)))},e.prototype.decodeToken=function(e){var t=e.split(".");if(3!==t.length)throw new Error("JWT must have 3 parts");var r=this.urlBase64Decode(t[1]);if(!r)throw new Error("Cannot decode the token");return JSON.parse(r)},e.prototype.getTokenExpirationDate=function(e){var t;if(t=this.decodeToken(e),"undefined"==typeof t.exp)return null;var r=new Date(0);return r.setUTCSeconds(t.exp),r},e.prototype.isTokenExpired=function(e,t){var r=this.getTokenExpirationDate(e);return t=t||0,null===r?!1:!(r.valueOf()>(new Date).valueOf()+1e3*t)},e}();exports.JwtHelper=JwtHelper,exports.tokenNotExpired=tokenNotExpired,exports.AUTH_PROVIDERS=[core_1.provide(AuthHttp,{useFactory:function(e){return new AuthHttp(new AuthConfig,e)},deps:[http_1.Http]})];